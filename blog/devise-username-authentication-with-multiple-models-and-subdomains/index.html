<!DOCTYPE html>
<html>
  <head>
    <title>Devise Username Authentication With Multiple Models And Subdomains</title>
    <meta name="author" content="Chris Oliver">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" >
    <meta name="google-site-verification" content="k8E8tt4Xn45P84zs5M6Z-4cMIGwdbGMJSDSkL6VzvMk" />

    <!--<link rel="shortcut icon" href="favicon.png">-->
    <link href='/assets/global-09e65ed72b4f08933d57dbbe6ee22514.css' rel='stylesheet' type='text/css' />


    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet" />

    <script type="text/javascript" src="/js/prism.js"></script>

    <script type="text/javascript" data-cfasync="false">
      (function() {
        var config = {
          kitId: 'voa6eso',
          scriptTimeout: 3000
        };
        var h=document.getElementsByTagName("html")[0];h.className+=" wf-loading";var t=setTimeout(function(){h.className=h.className.replace(/(\s|^)wf-loading(\s|$)/g," ");h.className+=" wf-inactive"},config.scriptTimeout);var tk=document.createElement("script"),d=false;tk.src='//use.typekit.net/'+config.kitId+'.js';tk.type="text/javascript";tk.async="true";tk.onload=tk.onreadystatechange=function(){var a=this.readyState;if(d||a&&a!="complete"&&a!="loaded")return;d=true;clearTimeout(t);try{Typekit.load(config)}catch(b){}};var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(tk,s)
      })();
    </script>

    <link href="https://plus.google.com/106699287110566383664/" rel="author" />
  </head>
  <body>
    <div class="fluid-container header">
  <div class="container">
    <nav class="pull-right">
      <!--<a href="http://gorails.com" class="btn btn-gorails btn-gorails-green">Learn Ruby On Rails</a>-->
      <!--<a href="/prototype">Prototype</a>
      <a href="/improve">Improve</a>
      <a>|</a>-->
      <a href="http://gorails.com">Learn Ruby on Rails</a>
      <a>|</a>
      <a href="/blog">Blog</a>
      <a href="/contact" class="btn btn-gorails btn-gorails-red">Hire Me</a>
    </nav>
    <h1 class="name"><a href="/">Chris Oliver</a></h1>
  </div>
</div>


    <section id="blog">
      <div class="container">
        <div class="row">
          <div class="span8 offset2">
            <div class="article-head">
              <h2 class="title"><a href="/blog/devise-username-authentication-with-multiple-models-and-subdomains" class="js-pjax">Devise Username Authentication With Multiple Models And Subdomains</a></h2>
              <p class="date">Jan 24, 2012</p>
            </div><!--/.article-head-->

            <div class="article-content">
              <p>Devise is an awesome library for authentication with Rails. Things are extremely simple to setup for most cases but when you begin implementing slightly trickier business logic, it can become a pain. And the real reason is mainly just because the wiki needs a little love. They iterate quickly, and documenting everything in a newbie friendly wiki page is often hard to do. So I’m going to take a quick stab at documenting my implementation:</p>

<h2>The Problem</h2>

<p>I’m working on an application that runs on multiple domains and subdomains. Each domain has it’s own set of admins and users. The admins are tied to a domain, and users are tied to a subdomain of that domain. Both of these need to allow authentication via a username field as opposed to the standard email field.</p>

<p>Starting out, we implemented the models just like normal with Devise. Generate custom views for each, and follow <a href="https://github.com/plataformatec/devise/wiki/How-To:-Allow-users-to-sign_in-using-their-username-or-email-address">this tutorial for adding username authentication</a>.</p>

<p>After I got everything setup, admin users could login just fine, but users could not. What was worse, was the Devise Sessions controller was executing but never calling <code>find_for_database_authentication</code> on the model. I had no idea what was going on, and all I could get Devise to do was return a <strong><code>Completed 401 Unauthorized</code></strong> error and immediately re-render the login form.</p>

<p>This is where we differentiate a bit. In that tutorial, they suggest that you set the <code>authentication_keys</code> in <code>devise.rb</code> like this:</p>

<pre><code>  config.authentication_keys = [ :login ]
</code></pre>

<p>Well this is actually going to be the source of our problems. In order to authenticate admins based upon a specific domain, we’re going to include the <code>domain_id</code> inside of the login form as a hidden field. In order to use the <code>domain_id</code> inside the model for authentication, we added it to the authentication_keys array:</p>

<pre><code>  config.authentication_keys = [ :login, :domain_id ]
</code></pre>

<p>But wait! That works for admins because they are based upon the domain. Users authenticate against a subdomain, not a <code>domain_id</code>. The users need authentication_keys like this:</p>

<pre><code>  config.authentication_keys = [ :login, :subdomain_id ]
</code></pre>

<p>And we put the <code>subdomain_id</code> as a hidden field in their new session form. This is a problem, because the initializer only runs once. We need some way to change this at runtime based upon which type of user is authenticating.</p>

<h2>The solution</h2>

<p>After a long time searching for a solution to the 401 Unauthorized, I found out that the authentication_keys was the cause of the problem (after having a hunch). The bad part was that I wasn’t able to find a method for debugging the issue.</p>

<p>I found the solution on <a href="http://stackoverflow.com/questions/3298506/about-user-authentication-with-username-and-subdomain">Stack Overflow</a> that pointed out that you’re actually able to set authentication_keys on the model itself in the devise call like so:</p>

<pre><code>  devise :database_authenticatable, :registerable, ..., :authentication_keys =&gt; [:login, :domain_id]
</code></pre>

<p>Nifty! We can set these dynamically without touching the initializer. This lets us cleanly customize the authentication without much work. I’ll be updating the wiki to add this functionality because I certainly can’t be the only one who searched long and hard for a solution!</p>


              <p><strong>P.S.</strong> <a href="https://twitter.com/excid3/">You might enjoy following me on Twitter.</a></p>
            </div><!--/.article-content-->

            <nav class="share">
              <a href="https://twitter.com/share" class="twitter-share-button" data-via="excid3" data-related="excid3">Tweet</a>
              <div class="g-plusone" data-size="medium"></div>
              <script src="//platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script><script type="IN/Share" data-counter="right"></script>
            </nav>

            <div class="blog-navigation">
              <div class="pull-left">
                
                <a href="/blog/happiness-leads-to-success-not-the-other-way-around" title="Happiness Leads To Success, Not The Other Way Around" class="btn btn-gorails btn-gorails-red">&laquo; Happiness Leads To Success, Not The Other Way Around</a>
                
              </div>

              <div class="pull-right">
                
                <a href="/blog/rails-tip-5-authenticated-root-and-dashboard-routes-with-devise" title="Rails Tip #5: Authenticated Root and Dashboard Routes With Devise" class="btn btn-gorails btn-gorails-red">Rails Tip #5: Authenticated Root and Dashboard Routes With Devise &raquo; </a>
                
              </div>
            </div>

            <div id="disqus_thread"></div>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

            <div class="light-well about">
              <a href="http://excid3.com">
                <div class="pull-left">
                  <img src="http://www.gravatar.com/avatar/ce795239ba5dd2384fc2f88ffaff5451.png" alt="Chris Oliver" />
                </div>
                <p>Chris Oliver specializes in web development and user experience design with Ruby on Rails, Javascript, HTML5, and CSS3 in St. Louis, MO</p>
              </a>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!--
<div id="footer-nav">
  <ul>
    <li><a class="home" href="http://excid3.com/blog">home</a></li>
    <li><a class="rss" href="http://feeds.feedburner.com/excid3">rss feed</a></li>
    <li><a class="archives" href="http://excid3.com/blog/archives/">archives</a></li>
    <li><a class="email" href="mailto:chris@excid3.com?subject=hello!">say hello</a></li>
    <li><a class="twitter" href="http://twitter.com/excid3">twitter</a></li>
    <li><a class="github" href="http://github.com/excid3">github</a></li>
  </ul>
</div>
-->


<footer class="clearfix">
  <div class="container">
    <p class="pull-left">Do things that scare you.</p>
    <p class="pull-right">Learn about <a href="http://gorails.com/st-louis-ruby-on-rails">St. Louis Ruby on Rails</a></p>
  </div>
</footer>


    <!-- SubHub.io -->
    <script>
      (function(s,u,b,hh,uu,bb){
        uu=document.createElement(u);
        uu.setAttribute('data-subhub',hh);
        uu.setAttribute('data-panel',true);
        uu.async=1;uu.src=b;
        bb=s.getElementsByTagName(u)[0];
        bb.parentNode.insertBefore(uu,bb);
      })(document, 'script',
        'https://assets.subhub.io/v1/subhub.js',
        'a48820f5-a170-4e4c-97cf-ced8d190679e');
    </script>

    <!-- Google Analytics -->
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-8399719-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'excid3'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>

    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

    <script type="text/javascript">
      (function() {
        var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
        po.src = 'https://apis.google.com/js/plusone.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
      })();
    </script>
  </body>
</html>

