<!DOCTYPE html>
<html>
  <head>
    <title>Rails ActiveRecord Multiple Databases And Migrations</title>
    <meta name="author" content="Chris Oliver">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" >
    <meta name="google-site-verification" content="k8E8tt4Xn45P84zs5M6Z-4cMIGwdbGMJSDSkL6VzvMk" />

    <!--<link rel="shortcut icon" href="favicon.png">-->
    <link href='/assets/global-09e65ed72b4f08933d57dbbe6ee22514.css' rel='stylesheet' type='text/css' />


    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet" />

    <script type="text/javascript" src="/js/prism.js"></script>

    <script type="text/javascript" data-cfasync="false">
      (function() {
        var config = {
          kitId: 'voa6eso',
          scriptTimeout: 3000
        };
        var h=document.getElementsByTagName("html")[0];h.className+=" wf-loading";var t=setTimeout(function(){h.className=h.className.replace(/(\s|^)wf-loading(\s|$)/g," ");h.className+=" wf-inactive"},config.scriptTimeout);var tk=document.createElement("script"),d=false;tk.src='//use.typekit.net/'+config.kitId+'.js';tk.type="text/javascript";tk.async="true";tk.onload=tk.onreadystatechange=function(){var a=this.readyState;if(d||a&&a!="complete"&&a!="loaded")return;d=true;clearTimeout(t);try{Typekit.load(config)}catch(b){}};var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(tk,s)
      })();
    </script>

    <link href="https://plus.google.com/106699287110566383664/" rel="author" />
  </head>
  <body>
    <div class="fluid-container header">
  <div class="container">
    <nav class="pull-right">
      <!--<a href="http://gorails.com" class="btn btn-gorails btn-gorails-green">Learn Ruby On Rails</a>-->
      <!--<a href="/prototype">Prototype</a>
      <a href="/improve">Improve</a>
      <a>|</a>-->
      <a href="http://gorails.com">Learn Ruby on Rails</a>
      <a>|</a>
      <a href="/blog">Blog</a>
      <a href="/contact" class="btn btn-gorails btn-gorails-red">Hire Me</a>
    </nav>
    <h1 class="name"><a href="/">Chris Oliver</a></h1>
  </div>
</div>


    <section id="blog">
      <div class="container">
        <div class="row">
          <div class="span8 offset2">
            <div class="article-head">
              <h2 class="title"><a href="/blog/rails-activerecord-multiple-databases-and-migrations" class="js-pjax">Rails ActiveRecord Multiple Databases And Migrations</a></h2>
              <p class="date">Aug 15, 2012</p>
            </div><!--/.article-head-->

            <div class="article-content">
              <p>Something we don’t see too much of is talk of using Ruby and ActiveRecord with multiple databases. Turns out it’s really simple. Let’s run through this.</p>

<h2>Rake Task</h2>

<p>Let’s dive right in. Obviously we want to handle migrations for two databases, so we need two separate Rake tasks to handle that:</p>

<pre><code>desc "Migrate the database through scripts in db/migrate."
namespace :db do
  task :migrate do
    Rake::Task["db:migrate_db1"].invoke
    Rake::Task["db:migrate_db2"].invoke
  end

  task :migrate_db1 do
    ActiveRecord::Base.establish_connection DB1_CONF
    ActiveRecord::Migrator.migrate("db/migrate/db1/")
  end

  task :migrate_db2 do
    ActiveRecord::Base.establish_connection DB2_CONF
    ActiveRecord::Migrator.migrate("db/migrate/db2/")
  end
end
</code></pre>

<p>Our first task here is <code>db:migrate</code> that delegates out to <code>db:migrate_db1</code> and <code>db:migrate_db2</code>.</p>

<p>Each of those establish a connection to the database and then runs the migrations from their own separate folders. This allows you to store migrations in separate folders so you can easily manage them.</p>

<p>Your migrations are exactly the same as normal.</p>

<h2>Database Connections</h2>

<p>In order to get those migrations to work, we need to configure the database connections. We’re going to define everything in the <code>database.yml</code> just like normal, but with a different naming convention:</p>

<pre><code>db1:
  development:
    adapter: mysql2
    database: db1_dev
    username: root

  test:
    adapter: mysql2
    database: db1_test
    username: root

  production:
    adapter: mysql2
    database: db1_prod
    username: root


db2:
  development:
    adapter: mysql2
    database: db2_dev
    username: root

  test:
    adapter: mysql2
    database: db2_test
    username: root

  production:
    adapter: mysql2
    database: db2_prod
    username: root
</code></pre>

<p>Here we are configuration two separate databases <code>db1</code> and <code>db2</code>.</p>

<p>We need to configure our app to load these now. I typically do this in boot.rb, but if you’re using Rails this may go in your <code>application.rb</code> or environment file(s).</p>

<pre><code>  ENV['ENV'] ||= 'development'

  db_conf = YAML::load(File.open(File.join(APP_PATH,'config','database.yml')))

  DB1_CONF = db_conf["db1"][ENV['ENV']]
  DB2_CONF = db_conf["db2"][ENV['ENV']]
</code></pre>

<p>So here, let’s take a look at what’s going on:</p>

<ol>
<li> We set the database configuration to use. Rails users can just use Rails.env here instead of <code>ENV['ENV']</code></li>
<li> Second we load up the database.yml config and parse it with YAML</li>
<li> Lastly, we grab the configuration from the file for each db and the correct environment that we’re running in.</li>
</ol>


<h2>Connecting Your Models</h2>

<p>When you’re working with multiple databases, I like to explicitly setup the connections inside the models themselves instead of inheriting from ActiveRecord::Base and using subclasses.</p>

<pre><code>class Message &lt; ActiveRecord::Base
  establish_connection DB1_CONF
end
</code></pre>

<p>And our second model in another database:</p>

<pre><code>class User &lt; ActiveRecord::Base
  establish_connection DB2_CONF
end
</code></pre>

<h2>Conclusion</h2>

<p>That's pretty much as simple as it is. All you really need to do is load the configurations, establish the database connections properly, and setup the migrations to load from a specific folder for each database.</p>

<p>I'm sure there are better ways of handling this, so if you have a suggestion, please let me know in the comments!</p>


              <p><strong>P.S.</strong> <a href="https://twitter.com/excid3/">You might enjoy following me on Twitter.</a></p>
            </div><!--/.article-content-->

            <nav class="share">
              <a href="https://twitter.com/share" class="twitter-share-button" data-via="excid3" data-related="excid3">Tweet</a>
              <div class="g-plusone" data-size="medium"></div>
              <script src="//platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script><script type="IN/Share" data-counter="right"></script>
            </nav>

            <div class="blog-navigation">
              <div class="pull-left">
                
                <a href="/blog/steli-efti-on-entrepreneurial-depression-and-happiness" title="Steli Efti on Entrepreneurial Depression and Happiness" class="btn btn-gorails btn-gorails-red">&laquo; Steli Efti on Entrepreneurial Depression and Happiness</a>
                
              </div>

              <div class="pull-right">
                
                <a href="/blog/would-you-like-to-become-a-better-programmer" title="Would You Like To Become A Better Programmer?" class="btn btn-gorails btn-gorails-red">Would You Like To Become A Better Programmer? &raquo; </a>
                
              </div>
            </div>

            <div id="disqus_thread"></div>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

            <div class="light-well about">
              <a href="http://excid3.com">
                <div class="pull-left">
                  <img src="http://www.gravatar.com/avatar/ce795239ba5dd2384fc2f88ffaff5451.png" alt="Chris Oliver" />
                </div>
                <p>Chris Oliver specializes in web development and user experience design with Ruby on Rails, Javascript, HTML5, and CSS3 in St. Louis, MO</p>
              </a>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!--
<div id="footer-nav">
  <ul>
    <li><a class="home" href="http://excid3.com/blog">home</a></li>
    <li><a class="rss" href="http://feeds.feedburner.com/excid3">rss feed</a></li>
    <li><a class="archives" href="http://excid3.com/blog/archives/">archives</a></li>
    <li><a class="email" href="mailto:chris@excid3.com?subject=hello!">say hello</a></li>
    <li><a class="twitter" href="http://twitter.com/excid3">twitter</a></li>
    <li><a class="github" href="http://github.com/excid3">github</a></li>
  </ul>
</div>
-->


<footer class="clearfix">
  <div class="container">
    <p class="pull-left">Do things that scare you.</p>
    <p class="pull-right">Learn about <a href="http://gorails.com/st-louis-ruby-on-rails">St. Louis Ruby on Rails</a></p>
  </div>
</footer>


    <!-- SubHub.io -->
    <script>
      (function(s,u,b,hh,uu,bb){
        uu=document.createElement(u);
        uu.setAttribute('data-subhub',hh);
        uu.setAttribute('data-panel',true);
        uu.async=1;uu.src=b;
        bb=s.getElementsByTagName(u)[0];
        bb.parentNode.insertBefore(uu,bb);
      })(document, 'script',
        'https://assets.subhub.io/v1/subhub.js',
        'a48820f5-a170-4e4c-97cf-ced8d190679e');
    </script>

    <!-- Google Analytics -->
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-8399719-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'excid3'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>

    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

    <script type="text/javascript">
      (function() {
        var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
        po.src = 'https://apis.google.com/js/plusone.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
      })();
    </script>
  </body>
</html>

